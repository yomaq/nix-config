name: Weekly Flake Update

on:
    schedule:
        - cron: "0 0 * * 4"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    update_and_check_flake:
        runs-on: ubuntu-latest
        env:
            NIXPKGS_ALLOW_UNFREE: 1
        steps:
            - name: Install sudo
              run: |
                  apt-get update
                  apt-get install -y sudo
            - uses: https://code.forgejo.org/actions/checkout@v6
              with:
                  token: ${{ secrets.PUSH_TOKEN }}
            - name: Set up Nix
              uses: https://github.com/cachix/install-nix-action@v31
              with:
                  nix_path: nixpkgs=channel:nixos-unstable
            - name: Run nix flake update
              run: |
                  nix flake update
            - name: Run nix flake check
              run: |
                  nix flake check --all-systems --verbose
            - name: Commit and Push flake.lock
              run: |
                  git config user.name "yomaq"
                  git config user.email "112864332+yomaq@users.noreply.github.com"
                  git add flake.lock
                  git diff --staged --quiet || git commit -m "Update flake.lock"
                  git push
